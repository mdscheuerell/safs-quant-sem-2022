---
output:
  xaringan::moon_reader:
    css: "my-theme.css"
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
---

```{r setup, include=FALSE, message=FALSE}
options(htmltools.dir.version = FALSE, servr.daemon = TRUE)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dpi=300, out.height="100%", out.width="100%")
library(icons)
```



class: center, middle

# Estimating metrics of community stability from time series data

## Mark Scheuerell

_U.S. Geological Survey<br>Washington Cooperative Fish and Wildlife Research Unit<br>School of Aquatic and Fishery Sciences<br>University of Washington<br>Seattle, WA_

.futnote.purple-text[`r icon_style(fontawesome("envelope"), fill = "#844870")` scheuerl@uw.edu]

.citation.blue-text[`r icon_style(fontawesome("twitter"), fill = "#488fdf")` @mark_scheuerell]

---

# Acknowledgments

.blue-text[
## Eli Holmes (NOAA)

## Eric Ward (NOAA)

## Steve Katz (WSU)
]


---

class: center, middle, inverse

# Estimating species interactions is a long-standing goal in ecology


---

class: middle

.green-text[
# Predation
]
.blue-text.center[
# Competition
]
.orange-text.right[
# Facilitation
]

---

class: frimg, inverse

background-image: url(figs/bob_paine.jpg)
background-size: 57%

.gray-text.photo-credit.center[Photo: Anne Paine]


---

class: frimg, inverse

background-image: url(figs/steve_carpenter.jpg)
background-size: 70%

.gray-text.photo-credit.center[Photo: Adam Hinterthuer]


---

# Estimating interactions from time series

```{r plot_many_ts, echo=FALSE, dpi=300, fig.height=4, fig.width=8, fig.align='center'}
NN <- 3
TT <- 30
MM <- 3
 
set.seed(123)
## MM x TT matrix of innovations
ww <- matrix(rnorm(MM*TT, 0, 1), MM, TT)
ww[,1] <- rnorm(MM, 0, sqrt(5))
## MM x TT matrix of scaled latent trends
xx <- t(scale(apply(ww,1,cumsum)))

## loadings matrix
ZZ <- matrix(runif(NN*MM, -1, 1), NN, MM)
diag(ZZ) <- rev(sort(abs(diag(ZZ))))
ZZ[upper.tri(ZZ)] <- 0
ZZ <- round(ZZ, 2)

## obs var
obs_var <- 0.2^2
## obs errors
ee <- t(MASS::mvrnorm(TT, matrix(0,NN,1), diag(obs_var,NN,NN)))
## NN x TT matrix of observed data
yy <- ZZ %*% xx + ee

clr <- viridis::plasma(NN, alpha=0.7, end=0.8)

vv <- sample(seq(NN), NN)

labs <- c("Producer", "Herbivore", "Predator")

par(mfrow=c(1,3), mai=c(0.5,0.5,0.5,0), omi=c(0,0,0,0)) 

for(i in 1:NN) {
	plot.ts(yy[vv[i],], lwd=3,
	        xlab="", xaxt="n", ylab="", yaxt="n", main = labs[i],
	        col=clr[i], bty="n", cex.main = 2)
}
```


---

# Density-dependent population growth

.blue-text[
### Discrete-time Gompertz model
]

$$N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}))}$$


---

# Example of Gompertz dynamics

```{r ex_gompertz, align.fig="center", fig.dim=c(6,4)}
## number of time steps
TT <- 30

r_max <- 1
b <- 0.8

NN <- rep(NA, TT)
NN[1] <- 1

for(tt in 2:TT) {
  NN[tt] <- NN[tt-1] * exp(r_max + (b - 1) * log(NN[tt-1]))
}

par(mai = c(1, 0.5, 0, 0), omi = c(0,0,0,0))
plot.ts(NN, lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        yaxt = "n",
        ylab = "")
text(x = 5, y = 120, expression(italic(r[max])==1))
text(x = 5, y = 100, expression(italic(b)==0.8))
mtext(expression(italic(N[t])),
      side = 2, line = 1, cex = 1.5)
```


---

# Example of Gompertz dynamics

```{r ex_gompertz_2, align.fig="center", fig.dim=c(6,4)}
## number of time steps
TT <- 30

r_max <- 1
b <- -0.8

NN <- rep(NA, TT)
NN[1] <- 1

for(tt in 2:TT) {
  NN[tt] <- NN[tt-1] * exp(r_max + (b - 1) * log(NN[tt-1]))
}

par(mai = c(1, 0.5, 0, 0), omi = c(0,0,0,0))
plot.ts(NN, lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        yaxt = "n",
        ylab = "")
text(x = 25, y = 2.5, expression(italic(r[max])==1))
text(x = 25, y = 2.3, expression(italic(b)==-0.8))
mtext(expression(italic(N[t])),
      side = 2, line = 1, cex = 1.5)
```


---

# Density-dependent population growth

.blue-text[
### Stochastic, discrete-time Gompertz model
]

$$N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}))} \underbrace{\exp{(e_t)}}_{\text{environment}}$$


---

# Density-dependent population growth

.blue-text[
### Stochastic, discrete-time Gompertz model
]

$$N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}))} \underbrace{\exp{(e_t)}}_{\text{environment}} \\
~ \\
~ \\
N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}) + w_t)} \\
~ \\
w_t \sim \text{N}(0,q)$$


---

# Example of stochastic Gompertz dynamics

```{r ex_gompertz_stoch, align.fig="center", fig.dim=c(6,4)}
set.seed(20220401)

b <- 0.8

ww <- rnorm(TT, 0, sqrt(0.1))

for(tt in 2:TT) {
  NN[tt] <- NN[tt-1] * exp(r_max + (b - 1) * log(NN[tt-1]) + ww[tt])
}

par(mai = c(1, 0.5, 0, 0), omi = c(0,0,0,0))
plot.ts(NN, lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        yaxt = "n",
        ylab = "")
text(x = 5, y = 130, expression(italic(r[max])==1))
text(x = 5, y = 110, expression(italic(b)==0.8))
text(x = 5, y = 90, expression(italic(q)==0.1))
mtext(expression(italic(N[t])),
      side = 2, line = 1, cex = 1.5)
```


---

# Density-dependent population growth

.blue-text[
### Stochastic, discrete-time Gompertz model (in log-space)
]

$$N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}) + w_t)} \\
~ \\
\Downarrow \\
~ \\
\begin{align}
\log(N_t) &= \log(N_{t-1}) + r_{\max} + (b - 1) \log(N_{t-1}) + w_t \\
~ \\
    &= \log(N_{t-1}) + r_{\max} + b \log(N_{t-1}) - \log(N_{t-1}) + w_t \\
~ \\
    &= r_{\max} + b \log(N_{t-1}) + w_t
\end{align}$$


---

# Density-dependent population growth

.blue-text[
### With a substitution, we can rewrite the model as an<br>_autoregressive model_ of order 1, or AR(1)
]

$$\begin{align}\log(N_t) = r_{\max} & + b \log(N_{t-1}) + w_t \\
~ \\
& \Downarrow x_t = \log(N_t)\\
~ \\
x_t = r_{\max} &+ b x_{t-1} + w_t \end{align}$$


---

class: middle

.green-text[
# Upwelling
]
.blue-text.center[
# Precipitation
]
.orange-text.right[
# Temperature
]


---

# Environmental effects on growth

.blue-text[
### We can include the effects of (lagged) covariates on intrinsic growth
]

$$x_t = r_{\max} + b x_{t-1} + C c_{t-h} + w_t$$


---

# Environmental effects on growth

.blue-text[
### We can include the effects of (lagged) covariates on intrinsic growth
]

$$x_t = r_{\max} + b x_{t-1} + C c_{t-h} + w_t$$

<br>

.blue-text[
### For example, a seasonal effect (sine wave)
]

$$c_t = \sin \left( \tfrac{\pi}{6} t \right)$$


---

# Environmental effects on dynamics

```{r ex_covar, , align.fig="center", fig.dim=c(6,4)}
ww <- xx <- rnorm(TT)
bb <- 0.7
CC <- 2
cc <- sin(2*pi*seq(TT)/12)
  
for(t in 2:TT) {
  xx[t] <- r_max + bb * xx[t-1] + CC * cc[t] + ww[t]
}

par(mai = c(1, 0.5, 0, 0), omi = c(0,0,0,0))
plot.ts(xx, ylim = range(xx,yy),
        lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        ylab = "", yaxt = "n")
mtext(expression(italic(x[t])),
      side = 2, line = 1, cex = 1.5)

# mtext(side = 3,
      # expression(italic(x[t])==italic(b)~italic(x[t-1])~+~italic(C)~italic(c[t])~+~italic(w[t])),
      # line = 0.5, adj = 0)
```


---

# Observation error

.blue-text[
### When our population censuses contain observation or sampling errors, we can add an observation (data) model
]

$$x_t = r_{\max} + b x_{t-1} + w_t \\
~ \\
y_t = x_t + v_t$$


---

# Example time series

```{r ex_ssm, align.fig="center", fig.dim=c(6,4)}
## number of time steps
TT <- 50
## strength of density-dependence (0 < b < 1)
bb <- 0.5
## time series of process errors with SD = 1
ww <- rnorm(TT, 0, sqrt(1))
## initialize state & set x0 = w0
xx <- ww
## loop over time steps
for(t in 2:TT) {
  xx[t] <- bb * xx[t-1] + ww[t]
}
## obs errors with var = 1.5
vv <- rnorm(TT, 0, sqrt(2))
## obs data
yy <- xx + vv

par(mai = c(1, 0.5, 0, 0), omi = c(0,0,0,0))
plot.ts(xx, lwd = 2, type = "o", pch = 16, col = "gray",
        ylim = c(min(xx,yy), max(xx,yy)), yaxt = "n",
        ylab = "")
mtext(expression(italic(x[t])~~or~~italic(y[t])),
      side = 2, line = 1, cex = 1.5)
lines(yy, lwd = 2, type = "o", pch = 16, col = "dodgerblue")
```


---

class: inverse, center, middle

# Community dynamics


---

# Estimating community interactions

### Number today is a function of the number yesterday

```{r MAR_diag_1, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## boundaries
ss <- 5
nn <- 8
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- seq(5,cc-ss,rr)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
y0 <- rr - ss
y1 <- ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm[2], y=ymt, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#656565", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=3)
text("yesterday", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=1)
## arrows
arrows(x0=xm[2], y0=y0, y1=y1,
       col="#656565", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```


---

# Estimating community interactions

### and the number of predators, prey & competitors

```{r MAR_diag_2, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm, y=rep(ymt,3),
        rectangles=matrix(c(2*ss,ss),3,2,byrow=TRUE),
        lty="solid",  bg=c("#c10101","#ff8100","#844870"),
        fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text(c("Predators","Prey","Competitors"),
     x=xm, y=rep(ymt,3), cex=1.7, col="#ffffff", pos=3)
text("yesterday", x=xm, y=rep(ymt,3), cex=1.7, col="#ffffff", pos=1)
## arrows
arrows(x0=ss*seq(2,6,2), x1=ss*seq(3,5),
       y0=y0, y1=y1,
       col=c("#c10101","#ff8100","#844870"), lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```


---

# State model for species interactions

### and external forces at various times

```{r MAR_diag_3, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm[2], y=ymt, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#339933", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("External", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=3)
text("forces", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=1)
## arrows
arrows(x0=xm[2], y0=y0, y1=y1,
       col="#339933", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```

---

# State model for species interactions

.blue-text[
### Sum of intra- and interspecific effects
]

$$x_{i,t} = r_{max, i} + \sum^{m}_{j = 1}{b_{i,j} x_{j,t}} + w_t$$

where $b_{i,j}$ is the effect of the $j^{th}$ species on species $i$ and

$b_{i=j}$ is the density-dependent effect


---

# State model for species interactions

.blue-text[
### We can write this model in matrix notation as
]

$$\mathbf{x}_t = \mathbf{r} +  \mathbf{B} \mathbf{x}_{t-1} + \mathbf{w}_t$$

with

$$\mathbf{r} =
\begin{bmatrix}
r_1 \\
r_2 \\
\vdots \\
r_m
\end{bmatrix} ~~~
\mathbf{B} =
\begin{bmatrix}
b_{1,1} & b_{1,2} & \dots & b_{1,m} \\
b_{2,1} & b_{2,2} & \dots & b_{2,m} \\
\vdots & \vdots & \ddots & \vdots \\
b_{m,1} & b_{m,2} & \dots & b_{m,m}
\end{bmatrix} ~~~
\mathbf{w}_t \sim \text{MVN}(\textbf{0}, \textbf{Q})$$


---

# Forms of covariances matrices $\mathbf{Q}$

.blue-text[
### No covariance (and $m = 4$)
]

$$\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & 0 & 0 & 0 \\
 0 & \sigma & 0 & 0 \\
 0 & 0 & \sigma & 0 \\
 0 & 0 & 0 & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & 0 & 0 & 0 \\
 0 & \sigma_2 & 0 & 0 \\
 0 & 0 & \sigma_3 & 0 \\
 0 & 0 & 0 & \sigma_4
\end{bmatrix}$$


---

# Forms of covariances matrices $\mathbf{Q}$

.blue-text[
### With covariance (and $m = 4$)
]

$$\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & \gamma & \gamma & \gamma \\
 \gamma & \sigma & \gamma & \gamma \\
 \gamma & \gamma & \sigma & \gamma \\
 \gamma & \gamma & \gamma & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & \gamma_{1,2} & \gamma_{1,3} & \gamma_{1,4} \\
 \gamma_{1,2} & \sigma_2 & \gamma_{2,3} & \gamma_{2,4} \\
 \gamma_{1,3} & \gamma_{2,3} & \sigma_3 & \gamma_{3,4} \\
 \gamma_{1,4} & \gamma_{2,4} & \gamma_{3,4} & \sigma_4
\end{bmatrix}$$


---

# State model for species interactions

.blue-text[
### Including the effects of exogenous drivers
]

$$\mathbf{x}_t = \mathbf{r} + \mathbf{B} \mathbf{x}_{t-1} + \mathbf{C} \mathbf{c}_{t-h} + \mathbf{w}_t$$

<br>

The $m \times p$ matrix $\mathbf{C}$ contains the effect(s) of each covariate (cols) on each state (rows)

The $p \times 1$ column vector $\mathbf{c}_{t-h}$ contains each of the $p$ covariates at time $t - k$


---

# Covariate effects

The effect(s) of covariates can vary by state/species/etc

$$\mathbf{C} =
\begin{bmatrix}
C_{1, Temp} & C_{1, DO} \\ 
C_{2, Temp} & C_{2, DO} \\ 
\vdots & \vdots \\ 
C_{m, Temp} & C_{m, DO}
\end{bmatrix}
~~ \text{or} ~~
\mathbf{C} =
\begin{bmatrix}
C_{Temp} & C_{DO} \\ 
C_{Temp} & C_{DO} \\ 
\vdots & \vdots \\ 
C_{Temp} & C_{DO}
\end{bmatrix}$$

with

$$\mathbf{c}_{t-h} =
\begin{bmatrix}
Temp_{t-h} \\
DO_{t-h}
\end{bmatrix}$$


---

# Simple model for 2+ time series | Random walk observed with error

$$x_{i,t} = x_{i,t-1} + w_{i,t} \\
y_{i,t} = x_{i,t} + a_i + v_{i,t}$$

with

$w_{i,t} \sim \text{N}(0, q)$

$v_{i,t} \sim \text{N}(0, r)$


---

# Random walk observed with error

$$x_{1,t} = x_{1,t-1} + w_{1,t} \\
x_{2,t} = x_{2,t-1} + w_{2,t} \\
\vdots \\
x_{n,t} = x_{n,t-1} + w_{n,t}$$

$$y_{1,t} = x_{1,t} + a_1 + v_{1,t} \\
y_{2,t} = x_{2,t} + a_2 + v_{2,t} \\
\vdots \\
y_{n,t} = x_{n,t} + a_2 + v_{n,t}$$


---

# Random walk observed with error

### In matrix form

$$\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t-1} \\
x_{2,t-1} \\
\vdots \\
x_{n,t-1} \\
\end{bmatrix} + 
\begin{bmatrix}
w_{1,t} \\
w_{2,t} \\
\vdots \\
w_{n,t} \\
\end{bmatrix}$$

$$\begin{bmatrix}
y_{1,t} \\
y_{2,t} \\
\vdots \\
y_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} + 
\begin{bmatrix}
a_1 \\
a_2 \\
\vdots \\
a_n \\
\end{bmatrix} + 
\begin{bmatrix}
v_{1,t} \\
v_{2,t} \\
\vdots \\
v_{n,t} \\
\end{bmatrix}$$


---

# Random walk observed with error 

### In matrix form

$$\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t$$

with 

$\mathbf{w}_t \sim \text{MVN}(\mathbf{0}, \mathbf{Q})$

$\mathbf{v}_t \sim \text{MVN}(\mathbf{0}, \mathbf{R})$


---

# Forms of covariances matrices $\mathbf{R}$

No covariance

$$\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & 0 & 0 & 0 \\
 0 & \sigma & 0 & 0 \\
 0 & 0 & \sigma & 0 \\
 0 & 0 & 0 & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & 0 & 0 & 0 \\
 0 & \sigma_2 & 0 & 0 \\
 0 & 0 & \sigma_3 & 0 \\
 0 & 0 & 0 & \sigma_4
\end{bmatrix}$$


---

# Forms of covariances matrices $\mathbf{R}$

With covariance

$$\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & \gamma & \gamma & \gamma \\
 \gamma & \sigma & \gamma & \gamma \\
 \gamma & \gamma & \sigma & \gamma \\
 \gamma & \gamma & \gamma & \sigma
\end{bmatrix}$$




---

# Random walk observed with error | In matrix form

$$\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t \\
\Downarrow \\
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{Z} \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t$$

with $\mathbf{Z}$ equal to the $n \times n$ Identity matrix $\mathbf{I}_n$


---

# Random walk observed with error | In matrix form

$$\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{Z} \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t$$

Note that both $\mathbf{x}_t$ and $\mathbf{y}_t$ are $n \times 1$ column vectors


---

# Multivariate autoregressive models

## Describe .blue-text[community dynamics] over time

```{r state_diag, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## boundaries
ss <- 5
nn <- 7
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- ss/2 + seq(0,cc-ss,ss)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
x0t <- seq(ss, by=2*ss, len=3)
x1t <- x0t + ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row: state
symbols(x=xm[c(1,3,5,7)], y=rep(ymt,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#488fdf",
        inches=FALSE, add=TRUE, lwd=3)
# text("Truth", x=-ss, y=ymt, adj=c(0,0.5), xpd=NA,
#      cex=2, col="#488fdf")
arrows(x0=x0t,x1=x1t,y0=ymt, col="#488fdf", lwd=3, length=0.12)
## Time or space
arrows(x0=ss/2, x1=cc-ss/2, y0=-ss/3+ss*2,
       length=0.12, lwd=3, xpd=NA)
text("Time", x=cc/2, y=-ss/2+ss*2, xpd=NA, pos=1, cex=2)
```

.gray-text.citation[Ives et al (2003) *Ecology*]


---

class: center, middle, inverse

# Observing nature can be easy

---

class: frimg, bottom, right
background-image: url(figs/sockeye.jpg)
background-size: cover

# .white-text[How many sockeye are there?]

---

class: center, middle, inverse

# Observing nature can also be hard

---

class: frimg, bottom, right
background-image: url(figs/sockeye.jpg)
background-size: cover

# .white-text[How many mayflies are there?]

---

# Multivariate autoregressive models

## .purple-text[Data] = .blue-text[Truth] &#177; .red-text[Errors]

```{r obs_diag, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## arrow locs
x0t <- seq(ss, by=2*ss, len=3)
x1t <- x0t + ss
y0b <- rr - ss
y1b <- ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row: state
symbols(x=xm[c(1,3,5,7)], y=rep(ymt,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#488fdf",
        inches=FALSE, add=TRUE, lwd=3)
text("Truth", x=-ss, y=ymt, adj=c(0,0.5), xpd=NA,
     cex=2, col="#488fdf")
## arrows
arrows(x0=x0t,x1=x1t,y0=ymt, col="#488fdf", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[c(1,3,5,7)], y=rep(ss/2,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#844870",
        inches=FALSE, add=TRUE, lwd=3)
text("Data", x=-ss, y=ss/2, adj=c(0,0.5), xpd=NA,
     cex=2, col="#844870")
## arrows
arrows(x0=xm[c(1,3,5,7)], y0=y0b, y1=y1b,
       col="#c10101", lwd=3, length=0.12)
## Time or space
arrows(x0=ss/2, x1=cc-ss/2, y0=-ss/3,
       length=0.12, lwd=3, xpd=NA)
text("Time", x=cc/2, y=-ss/2, xpd=NA, pos=1, cex=2)
```

---

# Multivariate autoregressive models

## .blue-text.under[State model]

## .blue-text[Density<sub><i>t</i></sub>] = *f* (.blue-text[Density<sub><i>t</i>-1 &nbsp;</sub>], .orange-text[Environment<sub><i>t-h &nbsp;</i></sub>], .gray-text[error<sub><i>t &nbsp;</i></sub>])

## .purple-text.under[Observation model]

## .purple-text[Data<sub><i>t</i></sub>] = *g* (.blue-text[Density<sub><i>t &nbsp;</i></sub>], .red-text[error<sub><i>t &nbsp;</i></sub>])

.gray-text.citation[Ives et al (2003) *Ecology*]


---

class: center, middle, inverse

# How does one actually do this?


---

# .green-text[Canned **R** packages]

## `dlm`, `vars`, `MARSS`<sup>*</sup>


.footnoteSm.gray-text[
<sup>\*</sup>Holmes, Ward, Scheuerell (2020) _Analysis of multivariate time-series using the MARSS package_
]


---

# .green-text[Canned **R** packages]

## `dlm`, `vars`, `MARSS`<sup>*</sup>

<br>

# .blue-text[Code-your-own]

## `JAGS`, `Stan`, `greta`

.footnoteSm.gray-text[
<sup>\*</sup>Holmes, Ward, Scheuerell (2020) _Analysis of multivariate time-series using the MARSS package_
]


---

# Density-dependent population growth

$$
x_t = r_{\max} + b x_{t-1} + w_t 
$$

It turns out that $r_{\max}$ and $b$ are confounded and create a likelihood surface with a strong ridge

This means we need a _long_ time series or mulitple observations of the process 

In practice, we will de-mean our data and instead use a familiar AR(1) model

$$
x_t = b x_{t-1} + w_t
$$


---

class: center, middle, inverse

# Real-world example


---

# Acknowledgments

.green-text[
## [the late] W. T. Edmondson (UW)

## Daniel Schindler (UW)

## Arni Litt and many others (UW)
]


