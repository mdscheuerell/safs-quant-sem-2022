---
output:
  xaringan::moon_reader:
    css: "my-theme.css"
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
---

```{r setup, include=FALSE, message=FALSE}
options(htmltools.dir.version = FALSE, servr.daemon = TRUE)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, dpi=300, out.height="100%", out.width="100%")
library(icons)
```



class: center, middle

# Estimating metrics of community stability from time series data

## Mark Scheuerell

_U.S. Geological Survey<br>Washington Cooperative Fish and Wildlife Research Unit<br>School of Aquatic and Fishery Sciences<br>University of Washington<br>Seattle, WA_

.futnote.purple-text[`r icon_style(fontawesome("envelope"), fill = "#844870")` scheuerl@uw.edu]

.citation.blue-text[`r icon_style(fontawesome("twitter"), fill = "#488fdf")` @mark_scheuerell]

---

# Acknowledgments

.blue-text[
## Eli Holmes (NOAA)

## Eric Ward (NOAA)

## Steve Katz (WSU)
]


---

class: center, middle, inverse

# Estimating species interactions is a long-standing goal in ecology


---

class: middle

.green-text[
# Predation
]
.blue-text.center[
# Competition
]
.orange-text.right[
# Facilitation
]

---

class: frimg, inverse

background-image: url(figs/bob_paine.jpg)
background-size: 57%

.gray-text.photo-credit.center[Photo: Anne Paine]


---

class: frimg, inverse

background-image: url(figs/steve_carpenter.jpg)
background-size: 70%

.gray-text.photo-credit.center[Photo: Adam Hinterthuer]


---

# Estimating interactions from time series

```{r plot_many_ts, echo=FALSE, dpi=300, fig.height=4, fig.width=8, fig.align='center'}
NN <- 3
TT <- 30
MM <- 3
 
set.seed(123)
## MM x TT matrix of innovations
ww <- matrix(rnorm(MM*TT, 0, 1), MM, TT)
ww[,1] <- rnorm(MM, 0, sqrt(5))
## MM x TT matrix of scaled latent trends
xx <- t(scale(apply(ww,1,cumsum)))

## loadings matrix
ZZ <- matrix(runif(NN*MM, -1, 1), NN, MM)
diag(ZZ) <- rev(sort(abs(diag(ZZ))))
ZZ[upper.tri(ZZ)] <- 0
ZZ <- round(ZZ, 2)

## obs var
obs_var <- 0.2^2
## obs errors
ee <- t(MASS::mvrnorm(TT, matrix(0,NN,1), diag(obs_var,NN,NN)))
## NN x TT matrix of observed data
yy <- ZZ %*% xx + ee

clr <- viridis::plasma(NN, alpha=0.7, end=0.8)

vv <- sample(seq(NN), NN)

labs <- c("Producer", "Herbivore", "Predator")

par(mfrow=c(1,3), mai=c(0.5,0.5,0.5,0), omi=c(0,0,0,0)) 

for(i in 1:NN) {
	plot.ts(yy[vv[i],], lwd=3,
	        xlab="", xaxt="n", ylab="", yaxt="n", main = labs[i],
	        col=clr[i], bty="n", cex.main = 2)
}
```


---

# Density-dependent population growth

Stochastic Gompertz model

$$N_t = N_{t-1} \text{e}^{(r_{max} + (b - 1) \log(N_{t-1}))} \text{e}^{w_t}  ~ \text{with} ~ w_t \sim \text{N}(0,q)$$


---

# Density-dependent population growth

Stochastic Gompertz model

$$
N_t = N_{t-1} \text{e}^{(r_{max} + (b - 1) \log(N_{t-1}))} \text{e}^{w_t}  ~ \text{with} ~ w_t \sim \text{N}(0,r)
$$

Taking the log of both sides and substituting $x_t$ for $\log(N_t)$

$$
\begin{align}
\log(N_t) & = \log(N_{t-1}) + r_{max} + (b - 1) \log(N_{t-1}) + w_t \\
& \Downarrow \\
x_t &= x_{t-1} + r_{max} + (b - 1) x_{t-1} + w_t \\
    &= x_{t-1} + r_{max} + b x_{t-1} - x_{t-1} + w_t \\
    &= r_{max} + b x_{t-1} + w_t
\end{align}
$$

---

# Density-dependent population growth

What is the mean of $\{x_t\}$?

$$
x_t = r_{max} + b x_{t-1} + w_t
$$


---

# Density-dependent population growth

What is the mean of $\{x_t\}$?

$$
x_t = r_{max} + b x_{t-1} + w_t
$$

$$
\text{E}(x_t) = \frac{r_{max}}{1 - b}
$$


---

# Density-dependent population growth

$$
x_t = r_{max} + b x_{t-1} + w_t
$$

It turns out that $r_{max}$ and $b$ are confounded and create a likelihood surface with a strong ridge

This means we need a _long_ time series or mulitple observations of the process 

In practice, we will de-mean our data and instead use a familiar AR(1) model

$$
x_t = b x_{t-1} + w_t
$$


---

# Density-dependent population growth

If our population censuses contain observation or sampling errors, we can use a state-space version

$$
x_t = b x_{t-1} + w_t \\
y_t = x_t + v_t
$$


---

# Simulate a Gompertz model

Simulate the AR(1) state model

```{r, echo=TRUE}
## number of time steps
TT <- 50
## strength of density-dependence (0 < b < 1)
bb <- 0.5
## time series of process errors with SD = 1
ww <- rnorm(TT, 0, sqrt(1))
## initialize state & set x0 = w0
xx <- ww
## loop over time steps
for(t in 2:TT) {
  xx[t] <- bb * xx[t-1] + ww[t]
}
```


---

# Simulate a Gompertz model

Add some observation error

```{r, echo=TRUE}
## obs errors with var = 0.5
vv <- rnorm(TT, 0, sqrt(0.5))
## obs data
yy <- xx + vv
```


---

# Plot a random walk

Plot the state and observation

```{r, echo=TRUE, eval=FALSE}
plot.ts(xx, lwd = 2, type = "o", pch = 16, col = "gray",
        ylim = c(min(xx,yy), max(xx,yy)),
        ylab = expression(italic(x[t])~~or~~italic(y[t])))
lines(yy, lwd = 2, type = "o", pch = 16, col = "blue")
```


---

# Plot a random walk

```{r, align.fig="center"}
par(mai = c(0.8,0.8,0,0), omi = c(0,0,0,0))
plot.ts(xx, lwd = 2, type = "o", pch = 16, col = "gray",
        ylim = c(min(xx,yy), max(xx,yy)),
        ylab = expression(italic(x[t])~~or~~italic(y[t])))
lines(yy, lwd = 2, type = "o", pch = 16, col = "blue")
```


---

# Covariates in state-space models

We can include covariates (explanatory variables) in our models as well

Covariates in the state model _affect the underlying process_

$$
x_t = b x_{t-1} + C c_t + w_t
$$


---

# Covariates in state-space models

We can include covariates (explanatory variables) in our models as well

Covariates in the state model _affect the underlying process_

$$
x_t = b x_{t-1} + C c_t + w_t
$$

Covariates in the observation model are _offsets to the underlying process_

$$
y_t = Z x_t + D d_t + v_t
$$


---

# Covariates in state-space models

```{r}
ww <- xx <- xy <- rnorm(TT)
bb <- 0.7
CC <- DD <- 2
cc <- dd <- sin(2*pi*seq(TT)/12)
  
for(t in 2:TT) {
  xx[t] <- bb * xx[t-1] + CC * cc[t] + ww[t]
  xy[t] <- bb * xy[t-1] + ww[t]
}
ee <- rnorm(TT)
yy <- xy + DD * dd # + ee
par(mai = c(0.9,0.9,0.5,0.1), omi = c(0,0,0,0))
plot.ts(xx, ylim = range(xx,yy),
        lwd = 2, type = "o", pch = 16, col = "gray",
        ylab = expression(italic(x[t])~~or~~italic(y[t])))
mtext(side = 3, expression(italic(x[t])==italic(b)~italic(x[t-1])~+~italic(C)~italic(c[t])~+~italic(w[t])),
      line = 0.5, adj = 0)
```


---

# Covariates in state-space models

```{r}
par(mai = c(0.9,0.9,0.5,0.1), omi = c(0,0,0,0))
plot.ts(xx, ylim = range(xx,yy),
        lwd = 2, type = "o", pch = 16, col = "gray",
        ylab = expression(italic(x[t])~~or~~italic(y[t])))
lines(yy, lwd = 2, type = "o", pch = 16, cex = 1.5, col = "blue")
mtext(side = 3, expression(italic(x[t])==italic(b)~italic(x[t-1])~+~italic(w[t])),
      line = 1.5, adj = 0)
mtext(side = 3, expression(italic(y[t])==italic(x[t])~+~italic(D)~italic(d[t])),
      line = 0.5, adj = 0)
```



---

# Simple model for 2+ time series | Random walk observed with error

$$
x_{i,t} = x_{i,t-1} + w_{i,t} \\
y_{i,t} = x_{i,t} + a_i + v_{i,t}
$$

with

$w_{i,t} \sim \text{N}(0, q)$

$v_{i,t} \sim \text{N}(0, r)$


---

# Random walk observed with error

$$
x_{1,t} = x_{1,t-1} + w_{1,t} \\
x_{2,t} = x_{2,t-1} + w_{2,t} \\
\vdots \\
x_{n,t} = x_{n,t-1} + w_{n,t}
$$

$$
y_{1,t} = x_{1,t} + a_1 + v_{1,t} \\
y_{2,t} = x_{2,t} + a_2 + v_{2,t} \\
\vdots \\
y_{n,t} = x_{n,t} + a_2 + v_{n,t} \\
$$


---

# Random walk observed with error | In matrix form

$$
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t-1} \\
x_{2,t-1} \\
\vdots \\
x_{n,t-1} \\
\end{bmatrix} + 
\begin{bmatrix}
w_{1,t} \\
w_{2,t} \\
\vdots \\
w_{n,t} \\
\end{bmatrix}
$$

$$
\begin{bmatrix}
y_{1,t} \\
y_{2,t} \\
\vdots \\
y_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} + 
\begin{bmatrix}
a_1 \\
a_2 \\
\vdots \\
a_n \\
\end{bmatrix} + 
\begin{bmatrix}
v_{1,t} \\
v_{2,t} \\
\vdots \\
v_{n,t} \\
\end{bmatrix}
$$


---

# Random walk observed with error | In matrix form

$$
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t
$$

with 

$\mathbf{w}_t \sim \text{MVN}(\mathbf{0}, \mathbf{Q})$

$\mathbf{v}_t \sim \text{MVN}(\mathbf{0}, \mathbf{R})$


---

# Forms of covariances matrices $\mathbf{Q}$

No covariance

$$
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & 0 & 0 & 0 \\
 0 & \sigma & 0 & 0 \\
 0 & 0 & \sigma & 0 \\
 0 & 0 & 0 & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & 0 & 0 & 0 \\
 0 & \sigma_2 & 0 & 0 \\
 0 & 0 & \sigma_3 & 0 \\
 0 & 0 & 0 & \sigma_4
\end{bmatrix}
$$


---

# Forms of covariances matrices $\mathbf{Q}$

With covariance

$$
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & \gamma & \gamma & \gamma \\
 \gamma & \sigma & \gamma & \gamma \\
 \gamma & \gamma & \sigma & \gamma \\
 \gamma & \gamma & \gamma & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{Q} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & \gamma_{1,2} & \gamma_{1,3} & \gamma_{1,4} \\
 \gamma_{1,2} & \sigma_2 & \gamma_{2,3} & \gamma_{2,4} \\
 \gamma_{1,3} & \gamma_{2,3} & \sigma_3 & \gamma_{3,4} \\
 \gamma_{1,4} & \gamma_{2,4} & \gamma_{3,4} & \sigma_4
\end{bmatrix}
$$


---

# Forms of covariances matrices $\mathbf{R}$

No covariance

$$
\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & 0 & 0 & 0 \\
 0 & \sigma & 0 & 0 \\
 0 & 0 & \sigma & 0 \\
 0 & 0 & 0 & \sigma
\end{bmatrix}
~\text{or}~~
\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma_1 & 0 & 0 & 0 \\
 0 & \sigma_2 & 0 & 0 \\
 0 & 0 & \sigma_3 & 0 \\
 0 & 0 & 0 & \sigma_4
\end{bmatrix}
$$


---

# Forms of covariances matrices $\mathbf{R}$

With covariance

$$
\mathbf{R} \stackrel{?}{=}
\begin{bmatrix}
 \sigma & \gamma & \gamma & \gamma \\
 \gamma & \sigma & \gamma & \gamma \\
 \gamma & \gamma & \sigma & \gamma \\
 \gamma & \gamma & \gamma & \sigma
\end{bmatrix}
$$




---

# Animal tracking

Estimating animal locations from tagging is a classic example of applying this type of multivariate state-space model

$$
LAT_t = LAT_{t-1} + w_{LAT,t} \\
LON_t = LON_{t-1} + w_{LON,t} \\
$$

$$
y_t = LAT_t + v_{y,t} \\
x_t = LON_t + v_{x,t} \\
$$


---

# Random walk observed with error | In matrix form

$$
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t \\
\Downarrow \\
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{Z} \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t
$$

with $\mathbf{Z}$ equal to the $n \times n$ Identity matrix $\mathbf{I}_n$


---

# Random walk observed with error | In matrix form

$$
\mathbf{x}_t = \mathbf{x}_{t-1} + \mathbf{w}_t \\
\mathbf{y}_t = \mathbf{Z} \mathbf{x}_t + \mathbf{a} + \mathbf{v}_t
$$

Note that both $\mathbf{x}_t$ and $\mathbf{y}_t$ are $n \times 1$ column vectors


---

# Multiple observations of one state

What if we had multiple observations of only 1 state?

If so, $\mathbf{x}_t$ would be a $1 \times 1$ vector (ie, a scalar) and $\mathbf{y}_t$ would be an $n \times 1$ column vector

$$
[x_t] = [x_{t-1}] + [w_t]
$$

$$
\begin{bmatrix}
y_{1,t} \\
y_{2,t} \\
\vdots \\
y_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} + 
\begin{bmatrix}
a_1 \\
a_2 \\
\vdots \\
a_n \\
\end{bmatrix} + 
\begin{bmatrix}
v_{1,t} \\
v_{2,t} \\
\vdots \\
v_{n,t} \\
\end{bmatrix}
$$


---

# Multiple observations of one state

$$
[x_t] = [x_{t-1}] + [w_t]
$$

$$
\begin{bmatrix}
y_{1,t} \\
y_{2,t} \\
\vdots \\
y_{n,t} \\
\end{bmatrix} =
\begin{bmatrix}
x_{1,t} \\
x_{2,t} \\
\vdots \\
x_{n,t} \\
\end{bmatrix} + 
\begin{bmatrix}
a_1 \\
a_2 \\
\vdots \\
a_n \\
\end{bmatrix} + 
\begin{bmatrix}
v_{1,t} \\
v_{2,t} \\
\vdots \\
v_{n,t} \\
\end{bmatrix}
$$

We need a way to map the $1 \times 1$ state onto the $n \times 1$ vector of observations

$$
\mathbf{y}_t = ~?~ x_t
$$


---

# Multiple observations of one state

We'll use the matrix $\mathbf{Z}$ we saw earlier and treat $x_t$ like a matrix

$$
\mathbf{y}_t = \mathbf{Z} \mathbf{x}_t
$$

Recall that the inner dimensions must match when multiplying matrices, such that

$$
[n \times m] [m \times p] = [n \times p]
$$

If $\mathbf{y}_t$ is $n \times 1$ and $\mathbf{x}_t$ is $1 \times 1$ then $\mathbf{Z}$ must be $n \times 1$ 

$$
[n \times 1] = [n \times 1] [1 \times 1]
$$


---

# Multiple observations of one state

For example

$$
\begin{bmatrix}
y_{1,t} \\
y_{2,t} \\
y_{3,t}
\end{bmatrix} =
\begin{bmatrix}
1 \\
1 \\
1
\end{bmatrix}
\begin{bmatrix}
x_t
\end{bmatrix} + 
\begin{bmatrix}
a_1 \\
a_2 \\
a_3
\end{bmatrix} + 
\begin{bmatrix}
v_{1,t} \\
v_{2,t} \\
v_{3,t}
\end{bmatrix}
$$


---

# Multiple obs of multiple states

What if we had $n$ observations of $m$ different states?

We just need to follow the same logic for matrix multiplication


---

# Multiple obs of multiple states

For example

$$
\begin{bmatrix}
 y_1 \\
 y_2 \\
 y_3 \\
 y_4 \\
 y_5 
\end{bmatrix}_t =
\begin{bmatrix}
 1 & 0 & 0 \\
 0 & 1 & 0 \\
 0 & 1 & 0 \\
 0 & 0 & 1 \\
 0 & 0 & 1 \\
\end{bmatrix} \times
\begin{bmatrix}
 x_1 \\
 x_2 \\
 x_3 
\end{bmatrix}_t +
\begin{bmatrix}
 a_1 \\
 a_2 \\
 a_3 \\
 a_4 \\
 a_5 
\end{bmatrix} +
\begin{bmatrix}
 v_1 \\
 v_2 \\
 v_3 \\
 v_4 \\
 v_5 
\end{bmatrix}_t
$$

$y_1$ observes $x_1$  
$y_2$ & $y_3$ observe $x_2$  
$y_4$ & $y_5$ observe $x_3$  


---

# Identification of population structure

We can use the same approach to systematically evaluate the data support for different hypotheses about the underlying population structure

$$
\mathbf{Z} =
\begin{bmatrix}
1 \\
1 \\
\vdots \\
1
\end{bmatrix}
~~ \text{vs} ~~
\mathbf{Z} =
\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
\vdots & \vdots & \vdots \\
0 & 0 & 1 
\end{bmatrix}
~~ \text{vs} ~~
\mathbf{Z} =
\begin{bmatrix}
1 & 0 & \dots & 0 \\
1 & 0 & \dots & 0 \\
\vdots & \vdots & \ddots & 0 \\
0 & 0 & \dots & 1 
\end{bmatrix}
$$


---

# Popn structure of harbor seals

Here is an example of using different forms of $\mathbf{Z}$ to evaluate the possible metapopulation structure of Harbor Seals

[Harbor seal example](https://nwfsc-timeseries.github.io/atsa-labs/sec-mss-west-coast-harbor-seals-counts.html)


---

# Estimating community interactions

Number today is a function of the number yesterday

```{r MAR_diag_1, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## boundaries
ss <- 5
nn <- 8
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- seq(5,cc-ss,rr)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
y0 <- rr - ss
y1 <- ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm[2], y=ymt, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#656565", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=3)
text("yesterday", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=1)
## arrows
arrows(x0=xm[2], y0=y0, y1=y1,
       col="#656565", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```


---

# Estimating community interactions

and the number of predators, prey & competitors

```{r MAR_diag_2, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm, y=rep(ymt,3),
        rectangles=matrix(c(2*ss,ss),3,2,byrow=TRUE),
        lty="solid",  bg=c("#c10101","#ff8100","#844870"),
        fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text(c("Predators","Prey","Competitors"),
     x=xm, y=rep(ymt,3), cex=1.7, col="#ffffff", pos=3)
text("yesterday", x=xm, y=rep(ymt,3), cex=1.7, col="#ffffff", pos=1)
## arrows
arrows(x0=ss*seq(2,6,2), x1=ss*seq(3,5),
       y0=y0, y1=y1,
       col=c("#c10101","#ff8100","#844870"), lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```


---

# State model for species interactions

and external forces at various times

```{r MAR_diag_3, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row
symbols(x=xm[2], y=ymt, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#339933", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("External", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=3)
text("forces", x=xm[2], y=ymt, cex=1.8, col="#ffffff", pos=1)
## arrows
arrows(x0=xm[2], y0=y0, y1=y1,
       col="#339933", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[2], y=ymb, rectangles=matrix(c(2*ss,ss),1,2),
        lty="solid",  bg="#488fdf", fg=NA,
        inches=FALSE, add=TRUE, lwd=3)
text("Number", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=3)
text("today", x=xm[2], y=ymb, cex=1.8, col="#ffffff", pos=1)
```

---

# State model for species interactions

$$
x_{i,t} = \sum^{m}_{j = 1}{b_{i,j} x_{j,t}} + w_t
$$

where $b_{i,j}$ is the effect of the $j^{th}$ species on species $i$

$b_{i,j}$ with $i = j$ is the density-dependent effect


---

# State model for species interactions

We can write this model in matrix notation as

$$
\mathbf{x}_t = \mathbf{B} \mathbf{x}_{t-1} + \mathbf{w}_t
$$

with

$$
\mathbf{B} =
\begin{bmatrix}
b_{1,1} & b_{1,2} & \dots & b_{1,m} \\
b_{2,1} & b_{1,2} & \dots & b_{2,m} \\
\vdots & \vdots & \ddots & \vdots \\
b_{m,1} & b_{m,2} & \dots & b_{m,m}
\end{bmatrix}
$$


---

# State model for species interactions

Including the effects of exogenous drivers yields

$$
\mathbf{x}_t = \mathbf{B} \mathbf{x}_{t-1} + \mathbf{C} \mathbf{c}_{t-k} + \mathbf{w}_t
$$

Note that the lag $k \geq 0$


---

# State model for species interactions

Including the effects of exogenous drivers

$$
\mathbf{x}_t = \mathbf{B} \mathbf{x}_{t-1} + \mathbf{C} \mathbf{c}_{t-k} + \mathbf{w}_t
$$

The $m \times p$ matrix $\mathbf{C}$ contains the effect(s) of each covariate (cols) on each state (rows)

The $p \times 1$ column vector $\mathbf{c}_{t-k}$ contains each of the $p$ covariates at time $t - k$


---

# Covariate effects

The effect(s) of covariates can vary by state/species/etc

$$
\mathbf{C} =
\begin{bmatrix}
C_{1, Temp} & C_{1, DO} \\ 
C_{2, Temp} & C_{2, DO} \\ 
\vdots & \vdots \\ 
C_{m, Temp} & C_{m, DO}
\end{bmatrix}
~~ \text{or} ~~
\mathbf{C} =
\begin{bmatrix}
C_{Temp} & C_{DO} \\ 
C_{Temp} & C_{DO} \\ 
\vdots & \vdots \\ 
C_{Temp} & C_{DO}
\end{bmatrix}
$$

with

$$
\mathbf{c}_{t-k} =
\begin{bmatrix}
Temp_{t-k} \\
DO_{t-k}
\end{bmatrix}
$$


---

# Multivariate autoregressive models

## Describe .blue-text[community dynamics] over time

```{r state_diag, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## boundaries
ss <- 5
nn <- 7
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- ss/2 + seq(0,cc-ss,ss)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
x0t <- seq(ss, by=2*ss, len=3)
x1t <- x0t + ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row: state
symbols(x=xm[c(1,3,5,7)], y=rep(ymt,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#488fdf",
        inches=FALSE, add=TRUE, lwd=3)
# text("Truth", x=-ss, y=ymt, adj=c(0,0.5), xpd=NA,
#      cex=2, col="#488fdf")
arrows(x0=x0t,x1=x1t,y0=ymt, col="#488fdf", lwd=3, length=0.12)
## Time or space
arrows(x0=ss/2, x1=cc-ss/2, y0=-ss/3+ss*2,
       length=0.12, lwd=3, xpd=NA)
text("Time", x=cc/2, y=-ss/2+ss*2, xpd=NA, pos=1, cex=2)
```

.gray-text.citation[Ives et al (2003) *Ecology*]


---

class: center, middle, inverse

# Observing nature can be easy

---

class: frimg, bottom, right
background-image: url(figs/sockeye.jpg)
background-size: cover

# .white-text[How many sockeye are there?]

---

class: center, middle, inverse

# Observing nature can also be hard

---

class: frimg, bottom, right
background-image: url(figs/sockeye.jpg)
background-size: cover

# .white-text[How many mayflies are there?]

---

# Multivariate autoregressive models

## .purple-text[Data] = .blue-text[Truth] &#177; .red-text[Errors]

```{r obs_diag, dpi=300, fig.height=4, fig.width=8, out.height="100%", out.width="100%", fig.align='center', echo=FALSE, warning=FALSE}
par(mai=c(0.8,0.8,0,0), omi=rep(0,4))
## arrow locs
x0t <- seq(ss, by=2*ss, len=3)
x1t <- x0t + ss
y0b <- rr - ss
y1b <- ss
## empty plot space
plot(c(0,cc), c(0,rr), type="n", xlab="", ylab="",
     xaxt="n", yaxt="n", bty="n")
## top row: state
symbols(x=xm[c(1,3,5,7)], y=rep(ymt,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#488fdf",
        inches=FALSE, add=TRUE, lwd=3)
text("Truth", x=-ss, y=ymt, adj=c(0,0.5), xpd=NA,
     cex=2, col="#488fdf")
## arrows
arrows(x0=x0t,x1=x1t,y0=ymt, col="#488fdf", lwd=3, length=0.12)
## bottom row: obs
symbols(x=xm[c(1,3,5,7)], y=rep(ss/2,4), circles=rep(ss/2,4),
        lty="solid",  fg=NA, bg="#844870",
        inches=FALSE, add=TRUE, lwd=3)
text("Data", x=-ss, y=ss/2, adj=c(0,0.5), xpd=NA,
     cex=2, col="#844870")
## arrows
arrows(x0=xm[c(1,3,5,7)], y0=y0b, y1=y1b,
       col="#c10101", lwd=3, length=0.12)
## Time or space
arrows(x0=ss/2, x1=cc-ss/2, y0=-ss/3,
       length=0.12, lwd=3, xpd=NA)
text("Time", x=cc/2, y=-ss/2, xpd=NA, pos=1, cex=2)
```

---

# Multivariate autoregressive models

## .blue-text.under[State model]

## .blue-text[Density<sub><i>t</i></sub>] = *f* (.blue-text[Density<sub><i>t</i>-1 &nbsp;</sub>], .orange-text[Environment<sub><i>t-h &nbsp;</i></sub>], .gray-text[error<sub><i>t &nbsp;</i></sub>])

## .purple-text.under[Observation model]

## .purple-text[Data<sub><i>t</i></sub>] = *g* (.blue-text[Density<sub><i>t &nbsp;</i></sub>], .red-text[error<sub><i>t &nbsp;</i></sub>])

.gray-text.citation[Ives et al (2003) *Ecology*]


---

class: center, middle, inverse

# How does one actually do this?


---

# .green-text[Canned **R** packages]

## `dlm`, `vars`, `MARSS`<sup>*</sup>


.footnoteSm.gray-text[
<sup>\*</sup>Holmes, Ward, Scheuerell (2020) _Analysis of multivariate time-series using the MARSS package_
]


---

# .green-text[Canned **R** packages]

## `dlm`, `vars`, `MARSS`<sup>*</sup>

<br>

# .blue-text[Code-your-own]

## `JAGS`, `Stan`, `greta`

.footnoteSm.gray-text[
<sup>\*</sup>Holmes, Ward, Scheuerell (2020) _Analysis of multivariate time-series using the MARSS package_
]


---

class: center, middle, inverse

# Real-world example


---

# Acknowledgments

.green-text[
## [the late] W. T. Edmondson (UW)

## Daniel Schindler (UW)

## Arni Litt and many others (UW)
]


